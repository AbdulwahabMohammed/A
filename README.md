# نظام إدارة الشهادات الصحية

هذا المشروع عبارة عن مثال مبسط لتطبيق ويب لإدارة الشهادات الصحية والبحث عنها في ثلاث قواعد بيانات مختلفة.

## المتطلبات
- Node.js 18+
- MySQL يتضمن قواعد البيانات الثلاث وجداول `HC_HealthCertificate`.

## تشغيل الخادم
1. قم بتثبيت الحزم:
   ```bash
   npm install
   ```
2. قبل التشغيل يجب إعداد متغيرات البيئة الخاصة بقواعد البيانات وروابط الطباعة والتحرير.
   يوجد ملف `.env.example` يوضح أسماء المتغيرات المطلوبة، انسخه إلى `.env`
   وعدِّل القيم لتناسب قواعدك، بما في ذلك المتغيرات `DBx_PRINT_URL` و `DBx_EDIT_URL`
   لكل قاعدة. تمثل هذه المتغيرات المسارات الأساسية لطباعة الشهادة وتحرير الشخص.
   كما يعرّف المتغير `ADD_CERT_URL` الرابط المستخدم لإضافة شهادة جديدة.
   يجب أن تنتهي قيمة `DBx_EDIT_URL` بشرطة مائلة `/` حيث يضيف البرنامج لاحقاً
   `<PersonId>?showdetail=HC_HealthCertificate` لبناء الرابط الكامل.
   عند تشغيل الخادم سيظهر في سجل التشغيل ما إذا كان الاتصال بكل قاعدة تم بنجاح
   (`Database 1 connected` وهكذا). في حال وجود خطأ ستظهر رسالة توضح سبب المشكلة.
3. شغّل الخادم:
   ```bash
   npm start
   ```
4. افتح المتصفح على `http://localhost:3000`.

يتم جلب القوائم المنسدلة ديناميكياً من الخادم عبر واجهات REST، كما يوفر الخادم نقاط نهاية للبحث وتحديث حالة الشهادات.
تتضمن واجهة البحث فلتر "حالة الشهادة" لاختيار (نشطة أو موقوفة أو نصاب).
كما يمكن استخدام خانة البحث الرئيسية للعثور على الشهادة برقم الهوية أو اسم الشخص أو اسم المورد أو اسم المنشأة، بالإضافة إلى رقم الشهادة أو الكود أو رقم المنشأة أو الرخصة.
ملحوظة: إحدى قواعد البيانات تستخدم جدولاً باسم مختلف للموردين، لذا يعتمد الخادم على منطق ديناميكي يجرب أولاً جدول `HC_suppliers` ثم `Supplier` عند توفره لدعم القواعد الثلاث بدون تعارض.
عند عرض النتائج يظهر رقم القاعدة (1 أو 2 أو 3) بدلاً من اسمها،
كما يُعرض اسم المورد بجوار اسم الشخص.
تُعرض النتائج في صفحات بحد أقصى 20 سجل في الصفحة مع إظهار عدد السجلات الكلي، كما يتم تلوين حالة الشهادة بشارات ملونة لسهولة التمييز.
يمكن الضغط على رقم الشهادة لفتح صفحة الطباعة في نافذة جديدة، ويتم توليد الرابط بناءً على المتغيرات `DBx_PRINT_URL` لكل قاعدة.
بالإضافة إلى ذلك يظهر زر تحرير بجوار أزرار التحكم يفتح مسار `DBx_EDIT_URL` متبوعاً بـ `<PersonId>?showdetail=HC_HealthCertificate` في تبويب جديد.

يعتمد المشروع على Bootstrap 5 بتنسيق RTL مع أيقونات Bootstrap Icons، واستخدام الخط الافتراضي "Segoe UI" لواجهة عربية أنيقة ومتجاوبة.

## التكامل مع GitHub

عند استقبال طلب webhook من GitHub (حدث `push`) على المسار `/webhook`,
يقوم الخادم بتنفيذ الأمر `git pull` داخل مجلد المشروع لتحديث الملفات.
يتم تسجيل نتيجة العملية في ملف `webhook.log` الموجود في جذر المشروع.
لأمانٍ أكثر يجب تحديد سر (secret) في إعدادات الـ webhook في GitHub،
ثم ضبط نفس القيمة في متغير البيئة `WEBHOOK_SECRET` على الخادم.
سيتم التحقق من ترويسة `X-Hub-Signature-256` أو `X-Hub-Signature`
ومطابقتها مع هذا السر وإرجاع `401 Unauthorized` عند عدم التطابق.
